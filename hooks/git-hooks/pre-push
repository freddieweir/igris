#!/bin/bash

# Pre-push Git Hook - Hardware Verification
# Installed by Igris yubikey-git-setup
# Requires physical hardware verification before pushing to remote

set -euo pipefail

# Locate Igris directory
TOMB_DIR="${TOMB_DIR:-/Users/fweir/git/internal/repos/igris}"
VERIFY_SCRIPT="${TOMB_DIR}/scripts/hardware-verify.sh"

# Color output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Check if verification script exists
if [ ! -x "$VERIFY_SCRIPT" ]; then
    echo -e "${YELLOW}⚠️  Hardware verification script not found at: $VERIFY_SCRIPT${NC}" >&2
    echo -e "${YELLOW}⚠️  Pre-push hook cannot enforce hardware requirement${NC}" >&2
    echo -e "${YELLOW}⚠️  This is a security risk! Please run setup again${NC}" >&2
    exit 0  # Don't block push if script is missing (for now)
fi

# Get push details from stdin
while read local_ref local_sha remote_ref remote_sha; do
    # Build a descriptive operation string
    OPERATION="git push (${remote_ref##refs/heads/} -> remote)"

    # Verify hardware
    if ! "$VERIFY_SCRIPT" "$OPERATION"; then
        echo -e "${RED}❌ Hardware verification failed in pre-push hook${NC}" >&2
        echo -e "${RED}❌ Push aborted for security${NC}" >&2
        exit 1
    fi

    # Only need to verify once per push (not per ref)
    break
done

exit 0
